<!DOCTYPE html>
<html lang="cs">
<head>
  <meta charset="UTF-8">
  <title>Otto ESP32 ‚Äì Robot & Servo Tester 360¬∞</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <style>
    :root{
      --bg:#050712;
      --bg-elevated:#111320;
      --bg-elevated-2:#181a28;
      --accent:#3d7bff;
      --accent-soft:rgba(61,123,255,0.25);
      --danger:#ff4b6a;
      --danger-soft:rgba(255,75,106,0.22);
      --success:#15c47e;
      --success-soft:rgba(21,196,126,0.22);
      --text:#f5f7ff;
      --text-muted:#9ba0c2;
      --border:rgba(255,255,255,0.06);
      --radius-lg:18px;
      --shadow-lg:0 22px 40px rgba(0,0,0,0.65);
    }
    *{box-sizing:border-box;}
    body{
      margin:0;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif;
      background:radial-gradient(circle at top,#181b35 0,#050712 50%);
      color:var(--text);
      min-height:100vh;
      display:flex;
      justify-content:center;
      padding:20px;
    }
    main{
      width:100%;
      max-width:1180px;
      background:rgba(5,7,18,0.96);
      border-radius:24px;
      box-shadow:var(--shadow-lg);
      border:1px solid rgba(255,255,255,0.05);
      padding:18px 20px 20px;
      backdrop-filter:blur(18px);
    }
    header{
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap:14px;
      margin-bottom:14px;
    }
    .title{
      font-size:1.4rem;
      font-weight:600;
    }
    .subtitle{
      font-size:0.8rem;
      color:var(--text-muted);
    }
    .badge-ip{
      font-size:0.8rem;
      padding:3px 10px;
      border-radius:999px;
      background:#111320;
      border:1px solid rgba(255,255,255,0.08);
      color:var(--text-muted);
      white-space:nowrap;
    }
    .mode-badges{
      display:flex;
      gap:6px;
      margin-top:4px;
      font-size:0.7rem;
    }
    .mode-pill{
      padding:3px 8px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,0.06);
      background:#111320;
      color:var(--text-muted);
    }
    .mode-pill.child{
      border-color:rgba(61,123,255,0.8);
      color:#dbe4ff;
    }

    .tabs{
      display:flex;
      gap:6px;
      background:#0a0c17;
      padding:4px;
      border-radius:999px;
      margin-bottom:12px;
    }
    .tab-btn{
      flex:1;
      border-radius:999px;
      border:none;
      padding:7px 0;
      font-size:0.8rem;
      background:transparent;
      color:var(--text-muted);
      cursor:pointer;
      transition:.18s;
      white-space:nowrap;
    }
    .tab-btn.active{
      background:linear-gradient(135deg,#3d7bff,#15c47e);
      color:#fff;
      box-shadow:0 10px 22px rgba(0,0,0,0.5);
    }
    .tab-panel{
      display:none;
    }
    .tab-panel.active{
      display:block;
    }

    .layout{
      display:grid;
      grid-template-columns:2.1fr 1.3fr;
      gap:14px;
    }
    @media(max-width:900px){
      .layout{
        grid-template-columns:1fr;
      }
      .tabs{
        flex-wrap:wrap;
      }
    }

    .card{
      background:var(--bg-elevated);
      border-radius:var(--radius-lg);
      border:1px solid var(--border);
      padding:12px 14px;
      box-shadow:0 10px 26px rgba(0,0,0,0.5);
    }
    h2{
      margin:0 0 6px;
      font-size:1.05rem;
    }
    h3{
      margin:10px 0 6px;
      font-size:0.95rem;
    }
    .small{
      font-size:0.76rem;
      color:var(--text-muted);
    }

    /* Servo cards */
    .servo-grid{
      display:grid;
      grid-template-columns:repeat(auto-fill,minmax(210px,1fr));
      gap:8px;
    }
    .servo-card{
      background:var(--bg-elevated-2);
      border-radius:14px;
      border:1px solid rgba(255,255,255,0.05);
      padding:8px 9px;
      font-size:0.8rem;
      display:flex;
      flex-direction:column;
      gap:4px;
    }
    .servo-header{
      display:flex;
      justify-content:space-between;
      align-items:center;
      font-weight:600;
    }
    .servo-state{
      font-size:0.7rem;
      color:var(--text-muted);
    }
    .servo-desc{
      width:100%;
      border-radius:10px;
      border:1px solid rgba(255,255,255,0.08);
      background:#090b15;
      color:var(--text);
      font-size:0.8rem;
      padding:4px 6px;
    }
    .servo-row{
      display:flex;
      gap:4px;
      margin-top:3px;
    }
    .servo-row select{
      flex:1;
      font-size:0.8rem;
      border-radius:8px;
      border:1px solid rgba(255,255,255,0.08);
      padding:3px 4px;
      background:#070915;
      color:var(--text);
    }

    /* Buttons */
    .btn-mini{
      padding:3px 6px;
      border-radius:999px;
      border:none;
      font-size:0.72rem;
      cursor:pointer;
      background:var(--accent-soft);
      color:var(--text);
    }
    .btn-mini:hover{ background:var(--accent); }
    .btn-mini.danger{
      background:var(--danger-soft);
      color:#ffd7e0;
    }
    .btn-mini.danger:hover{ background:var(--danger); }
    .btn-mini.secondary{
      background:#151827;
      color:var(--text-muted);
    }
    .btn-mini.secondary:hover{ background:#22263a; }

    .btn{
      border-radius:999px;
      border:none;
      padding:7px 13px;
      font-size:0.8rem;
      cursor:pointer;
      background:var(--accent-soft);
      color:var(--text);
      display:inline-flex;
      align-items:center;
      gap:5px;
    }
    .btn:hover{ background:var(--accent); }
    .btn.secondary{
      background:#151827;
      color:var(--text-muted);
    }
    .btn.secondary:hover{ background:#1d2132; }
    .btn.danger{
      background:var(--danger-soft);
      color:#ffd7e0;
    }
    .btn.danger:hover{ background:var(--danger); }
    .btn-save{
      background:var(--success-soft);
      color:#d7ffef;
    }
    .btn-save:hover{ background:var(--success); }

    .row{
      display:flex;
      flex-wrap:wrap;
      gap:6px;
      margin-top:6px;
      align-items:center;
    }

    input[type="number"],
    input[type="text"],
    textarea,
    select{
      font-family:inherit;
      outline:none;
    }
    input[type="number"],
    input[type="text"]{
      background:#070915;
      border-radius:999px;
      border:1px solid rgba(255,255,255,0.1);
      padding:4px 8px;
      font-size:0.8rem;
      color:var(--text);
      min-width:60px;
    }
    textarea{
      width:100%;
      min-height:140px;
      background:#070915;
      border-radius:14px;
      border:1px solid rgba(255,255,255,0.1);
      padding:6px 8px;
      font-size:0.8rem;
      color:var(--text);
      resize:vertical;
    }
    code{
      font-family:Menlo,Consolas,monospace;
      font-size:0.75rem;
      background:#090b17;
      padding:1px 4px;
      border-radius:4px;
    }

    /* File list */
    .file-list{
      max-height:220px;
      overflow:auto;
      font-size:0.78rem;
      border-radius:12px;
      border:1px solid rgba(255,255,255,0.06);
      background:#090b15;
      margin-top:4px;
    }
    .file-list-item{
      padding:4px 7px;
      border-bottom:1px solid rgba(255,255,255,0.03);
      display:flex;
      justify-content:space-between;
      gap:6px;
      align-items:center;
    }
    .file-list-item:last-child{ border-bottom:none; }
    .file-name{
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .file-actions button{
      border:none;
      border-radius:999px;
      padding:2px 6px;
      font-size:0.7rem;
      cursor:pointer;
      background:#151826;
      color:var(--text-muted);
    }
    .file-actions button:hover{ background:#22263a; }
    .file-actions button.danger{
      background:var(--danger-soft);
      color:#ffd7e0;
    }
    .file-actions button.danger:hover{ background:var(--danger); }
    .file-list-item .meta{
      font-size:0.75rem;
      color:var(--text-muted);
    }

    /* Remote ovladaƒç ‚Äì dospƒõl√Ω */
    .remote-grid{
      display:grid;
      grid-template-columns:repeat(3,80px);
      grid-template-rows:repeat(3,80px);
      gap:0.75rem;
      justify-content:center;
      margin:0.75rem 0 0.5rem;
    }
    .remote-btn{
      width:80px;
      height:80px;
      border-radius:50%;
      font-size:1.8rem;
      border:none;
      cursor:pointer;
      background:var(--accent-soft);
      color:var(--text);
      box-shadow:0 6px 18px rgba(0,0,0,0.5);
    }
    .remote-btn:hover{
      background:var(--accent);
      transform:translateY(-1px);
    }
    .remote-btn:active{
      transform:translateY(1px) scale(0.98);
      box-shadow:0 3px 10px rgba(0,0,0,0.7);
    }
    .remote-center{
      background:var(--success-soft);
    }
    .remote-center:hover{ background:var(--success); }

    .remote-table{
      width:100%;
      border-collapse:collapse;
      font-size:0.8rem;
      margin-top:0.5rem;
    }
    .remote-table th,
    .remote-table td{
      padding:0.25rem 0.3rem;
      border-bottom:1px solid rgba(255,255,255,0.04);
    }
    .remote-table th{
      text-align:left;
      color:var(--text-muted);
      font-weight:normal;
    }
    .remote-table select{ min-width:90px; }
    .remote-seq-select{
      width:100%;
      margin-bottom:2px;
    }
    .remote-url-input{
      width:100%;
    }

    /* Dƒõtsk√Ω re≈æim ‚Äì velk√° tlaƒç√≠tka s obr√°zky */
    .kid-layout{
      display:flex;
      flex-direction:column;
      gap:12px;
    }
    @media(min-width:900px){
      .kid-layout{
        flex-direction:row;
      }
    }
    .kid-main,
    .kid-extra{
      flex:1;
    }
    .kid-section{
      margin-top:0.4rem;
    }
    .kid-label{
      font-size:0.8rem;
      color:var(--text-muted);
      margin-bottom:0.2rem;
    }
    .kid-grid{
      display:grid;
      grid-template-columns:repeat(3,100px);
      grid-template-rows:repeat(3,100px);
      gap:1rem;
      justify-content:center;
      margin:0.8rem 0 0.4rem;
    }
    .kid-btn{
      width:100px;
      height:100px;
      border-radius:28px;
      border:none;
      cursor:pointer;
      font-size:2.2rem;
      background:var(--accent-soft);
      color:var(--text);
      box-shadow:0 10px 26px rgba(0,0,0,0.6);
    }
    .kid-btn:hover{
      background:var(--accent);
      transform:translateY(-1px);
    }
    .kid-btn:active{
      transform:translateY(1px) scale(0.98);
      box-shadow:0 4px 12px rgba(0,0,0,0.7);
    }
    .kid-btn-center{
      background:var(--success-soft);
    }
    .kid-btn-center:hover{ background:var(--success); }

    .kid-body-grid{
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(130px,1fr));
      gap:0.8rem;
      margin-top:0.6rem;
    }
    .kid-body-col{
      text-align:center;
    }
    .kid-body-icon{
      font-size:2rem;
      margin-bottom:0.25rem;
    }
    .kid-body-arrows{
      display:flex;
      justify-content:center;
      gap:0.4rem;
    }
    .kid-btn-small{
      width:64px;
      height:64px;
      border-radius:20px;
      border:none;
      cursor:pointer;
      font-size:1.6rem;
      background:var(--accent-soft);
      color:var(--text);
      box-shadow:0 8px 22px rgba(0,0,0,0.6);
    }
    .kid-btn-small:hover{
      background:var(--accent);
      transform:translateY(-1px);
    }
    .kid-btn-small:active{
      transform:translateY(1px) scale(0.98);
      box-shadow:0 3px 10px rgba(0,0,0,0.7);
    }
    .kid-status{
      margin-top:0.5rem;
      padding:4px 8px;
      border-radius:999px;
      background:#151827;
      font-size:0.75rem;
      color:var(--text-muted);
      text-align:center;
    }

    /* OTTO DIY robot ‚Äì diagram */
    .otto-card{ margin-top:0.8rem; }
    .otto-diagram{
      display:grid;
      grid-template-columns:repeat(3,minmax(80px,1fr));
      grid-auto-rows:auto;
      gap:0.6rem;
      justify-content:center;
      margin-top:0.4rem;
    }
    .otto-shape{
      border-radius:12px;
      border:1px solid rgba(255,255,255,0.12);
      background:rgba(15,18,35,0.9);
      box-shadow:0 6px 16px rgba(0,0,0,0.5);
    }
    .otto-head{
      height:40px;
      width:60px;
      margin:0 auto;
    }
    .otto-body{
      height:60px;
      width:70px;
      margin:0 auto;
    }
    .otto-leg{
      height:40px;
      width:26px;
      margin:0 auto;
    }
    .otto-foot{
      height:20px;
      width:40px;
      margin:0 auto;
    }
    .otto-part{
      text-align:center;
      font-size:0.7rem;
      color:var(--text-muted);
    }
    .otto-seq{
      margin-top:0.25rem;
      display:flex;
      flex-direction:column;
      align-items:center;
      gap:4px;
    }
    .otto-seq-row{
      display:flex;
      gap:4px;
      align-items:center;
      justify-content:center;
      width:100%;
    }
    .otto-seq-row input,
    .otto-seq-row select{
      flex:1;
      min-width:0;
      font-size:0.7rem;
      background:#070915;
      border-radius:999px;
      border:1px solid rgba(255,255,255,0.1);
      padding:3px 4px;
      color:var(--text);
    }
    .otto-label-strong{
      font-weight:600;
      color:var(--text);
    }
  </style>
</head>
<body>
<main>
  <header>
    <div>
      <div class="title">Otto ESP32 ‚Äì Robot & Servo Tester 360¬∞</div>
      <div class="subtitle">6√ó SG90 360¬∞ ¬∑ webov√© UI ¬∑ sekvence ¬∑ OTA ¬∑ LittleFS</div>
      <div class="mode-badges">
        <div class="mode-pill child">üë¶ Dƒõtsk√© ovl√°d√°n√≠ ‚Äì obr√°zky</div>
        <div class="mode-pill">üõ† Re≈æim dospƒõl√©ho ‚Äì nastaven√≠ robota</div>
      </div>
    </div>
    <div class="badge-ip" id="ipBadge">IP: zjist√≠ se z prohl√≠≈æeƒçe</div>
  </header>

  <div class="tabs">
    <button class="tab-btn active" data-tab="tab-kid">üë¶ D√≠tƒõ</button>
    <button class="tab-btn" data-tab="tab-remote">üïπ Ovladaƒç</button>
    <button class="tab-btn" data-tab="tab-control">‚öô Serva</button>
    <button class="tab-btn" data-tab="tab-seq">üìú Sekvence</button>
    <button class="tab-btn" data-tab="tab-ota">‚¨Ü OTA &amp; soubory</button>
  </div>

  <!-- TAB: Dƒõtsk√© ovl√°d√°n√≠ -->
  <div class="tab-panel active" id="tab-kid">
    <div class="kid-layout">
      <div class="kid-main">
        <div class="card">
          <h2>Ovl√°d√°n√≠ pro dƒõti</h2>
          <p class="small">
            D√≠tƒõ maƒçk√° jen velk√° tlaƒç√≠tka se symboly. Co dƒõlaj√≠, nastav√≠≈° v z√°lo≈æk√°ch
            <strong>Ovladaƒç</strong> a <strong>Sekvence</strong>.
          </p>

          <div class="kid-section">
            <div class="kid-label">Ch≈Øze robota (mapuje se v ‚ÄûNastaven√≠ ovladaƒçe‚Äú)</div>
            <div class="kid-grid">
              <div></div>
              <button class="kid-btn" onclick="kidRemoteFire(0)" title="dop≈ôedu">‚ñ≤</button>
              <div></div>

              <button class="kid-btn" onclick="kidRemoteFire(2)" title="doleva">‚óÄ</button>
              <button class="kid-btn kid-btn-center" onclick="kidRemoteFire(4)" title="otoƒçka vlevo">‚Ü∫</button>
              <button class="kid-btn" onclick="kidRemoteFire(3)" title="doprava">‚ñ∂</button>

              <div></div>
              <button class="kid-btn" onclick="kidRemoteFire(1)" title="dozadu">‚ñº</button>
              <button class="kid-btn" onclick="kidRemoteFire(5)" title="otoƒçka vpravo">‚Üª</button>
            </div>
          </div>

          <div id="kidStatus" class="kid-status">P≈ôipraveno.</div>
        </div>
      </div>

      <div class="kid-extra">
        <div class="card">
          <h2>Ruce, nohy a chodidla</h2>
          <p class="small">
            Tato tlaƒç√≠tka spou≈°t√≠ sekvence z diagramu OTTO v z√°lo≈æce
            <strong>Ovladaƒç</strong>. Vybere≈° je tam z rozbalovac√≠ho seznamu.
          </p>

          <div class="kid-body-grid">
            <div class="kid-body-col">
              <div class="kid-body-icon">üëã</div>
              <div class="kid-label">L ruka</div>
              <div class="kid-body-arrows">
                <button class="kid-btn-small" onclick="kidOttoSeqFire('otto_seq_arm_left_up')" title="L ruka nahoru">‚ñ≤</button>
                <button class="kid-btn-small" onclick="kidOttoSeqFire('otto_seq_arm_left_down')" title="L ruka dol≈Ø">‚ñº</button>
              </div>
            </div>

            <div class="kid-body-col">
              <div class="kid-body-icon">üëã</div>
              <div class="kid-label">P ruka</div>
              <div class="kid-body-arrows">
                <button class="kid-btn-small" onclick="kidOttoSeqFire('otto_seq_arm_right_up')" title="P ruka nahoru">‚ñ≤</button>
                <button class="kid-btn-small" onclick="kidOttoSeqFire('otto_seq_arm_right_down')" title="P ruka dol≈Ø">‚ñº</button>
              </div>
            </div>

            <div class="kid-body-col">
              <div class="kid-body-icon">ü¶µ</div>
              <div class="kid-label">L stehno</div>
              <div class="kid-body-arrows">
                <button class="kid-btn-small" onclick="kidOttoSeqFire('otto_seq_thigh_left_left')" title="L stehno doleva">‚óÄ</button>
                <button class="kid-btn-small" onclick="kidOttoSeqFire('otto_seq_thigh_left_right')" title="L stehno doprava">‚ñ∂</button>
              </div>
            </div>

            <div class="kid-body-col">
              <div class="kid-body-icon">ü¶µ</div>
              <div class="kid-label">P stehno</div>
              <div class="kid-body-arrows">
                <button class="kid-btn-small" onclick="kidOttoSeqFire('otto_seq_thigh_right_left')" title="P stehno doleva">‚óÄ</button>
                <button class="kid-btn-small" onclick="kidOttoSeqFire('otto_seq_thigh_right_right')" title="P stehno doprava">‚ñ∂</button>
              </div>
            </div>

            <div class="kid-body-col">
              <div class="kid-body-icon">ü¶∂</div>
              <div class="kid-label">L chodidlo</div>
              <div class="kid-body-arrows">
                <button class="kid-btn-small" onclick="kidOttoSeqFire('otto_seq_foot_left_up')" title="L chodidlo nahoru">‚ñ≤</button>
                <button class="kid-btn-small" onclick="kidOttoSeqFire('otto_seq_foot_left_down')" title="L chodidlo dol≈Ø">‚ñº</button>
              </div>
            </div>

            <div class="kid-body-col">
              <div class="kid-body-icon">ü¶∂</div>
              <div class="kid-label">P chodidlo</div>
              <div class="kid-body-arrows">
                <button class="kid-btn-small" onclick="kidOttoSeqFire('otto_seq_foot_right_up')" title="P chodidlo nahoru">‚ñ≤</button>
                <button class="kid-btn-small" onclick="kidOttoSeqFire('otto_seq_foot_right_down')" title="P chodidlo dol≈Ø">‚ñº</button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- TAB: Ovladaƒç (dospƒõl√Ω) -->
  <div class="tab-panel" id="tab-remote">
    <div class="card">
      <h2>D√°lkov√© ovl√°d√°n√≠ robota</h2>
      <p class="small">
        ≈†ipky spou≈°tƒõj√≠ p≈ôednastaven√© sekvence nebo vlastn√≠ p≈ô√≠kazy.  
        D√≠tƒõ v z√°lo≈æce <strong>D√≠tƒõ</strong> pou≈æ√≠v√° stejn√© mapov√°n√≠, ale jen obr√°zky.
      </p>

      <div class="remote-grid">
        <div></div>
        <button class="remote-btn" onclick="remoteFire(0)" title="Dop≈ôedu (‚ñ≤)">‚ñ≤</button>
        <div></div>

        <button class="remote-btn" onclick="remoteFire(2)" title="Vlevo (‚óÄ)">‚óÄ</button>
        <button class="remote-btn remote-center" onclick="remoteFire(4)" title="Otoƒçka vlevo ‚Ü∫">‚Ü∫</button>
        <button class="remote-btn" onclick="remoteFire(3)" title="Vpravo (‚ñ∂)">‚ñ∂</button>

        <div></div>
        <button class="remote-btn" onclick="remoteFire(1)" title="Dozadu (‚ñº)">‚ñº</button>
        <button class="remote-btn" onclick="remoteFire(5)" title="Otoƒçka vpravo ‚Üª">‚Üª</button>
      </div>

      <p class="small" id="remoteStatus">P≈ôipraveno.</p>

      <hr style="border-color:rgba(255,255,255,0.04);margin:0.7rem 0;">

      <h3 style="margin-top:0;">Nastaven√≠ ovladaƒçe</h3>
      <p class="small">
        Ke ka≈æd√©mu tlaƒç√≠tku m≈Ø≈æe≈° p≈ôi≈ôadit:
        <ul class="small">
          <li><strong>sekvenci</strong> ‚Äì vyb√≠r√° se z ulo≈æen√Ωch sekvenc√≠,</li>
          <li><strong>URL p≈ô√≠kaz</strong> ‚Äì vlastn√≠ API vol√°n√≠ (nap≈ô. <code>/api/move_angle?...</code>),</li>
          <li><strong>vypnuto</strong> ‚Äì tlaƒç√≠tko nic nedƒõl√°.</li>
        </ul>
      </p>

      <table class="remote-table">
        <thead>
        <tr>
          <th>Tlaƒç√≠tko</th>
          <th>Akce</th>
          <th>Sekvence / URL</th>
        </tr>
        </thead>
        <tbody>
        <tr>
          <td>Dop≈ôedu (‚ñ≤)</td>
          <td>
            <select id="remote_type_0" onchange="remoteChanged(0)">
              <option value="none">vypnuto</option>
              <option value="seq">sekvence</option>
              <option value="url">URL p≈ô√≠kaz</option>
            </select>
          </td>
          <td>
            <select id="remote_seq_0" class="remote-seq-select" onchange="remoteChanged(0)"></select>
            <input id="remote_url_0" class="remote-url-input" placeholder="/api/..." onchange="remoteChanged(0)" style="display:none;">
          </td>
        </tr>
        <tr>
          <td>Dozadu (‚ñº)</td>
          <td>
            <select id="remote_type_1" onchange="remoteChanged(1)">
              <option value="none">vypnuto</option>
              <option value="seq">sekvence</option>
              <option value="url">URL p≈ô√≠kaz</option>
            </select>
          </td>
          <td>
            <select id="remote_seq_1" class="remote-seq-select" onchange="remoteChanged(1)"></select>
            <input id="remote_url_1" class="remote-url-input" placeholder="/api/..." onchange="remoteChanged(1)" style="display:none;">
          </td>
        </tr>
        <tr>
          <td>Doleva (‚óÄ)</td>
          <td>
            <select id="remote_type_2" onchange="remoteChanged(2)">
              <option value="none">vypnuto</option>
              <option value="seq">sekvence</option>
              <option value="url">URL p≈ô√≠kaz</option>
            </select>
          </td>
          <td>
            <select id="remote_seq_2" class="remote-seq-select" onchange="remoteChanged(2)"></select>
            <input id="remote_url_2" class="remote-url-input" placeholder="/api/..." onchange="remoteChanged(2)" style="display:none;">
          </td>
        </tr>
        <tr>
          <td>Doprava (‚ñ∂)</td>
          <td>
            <select id="remote_type_3" onchange="remoteChanged(3)">
              <option value="none">vypnuto</option>
              <option value="seq">sekvence</option>
              <option value="url">URL p≈ô√≠kaz</option>
            </select>
          </td>
          <td>
            <select id="remote_seq_3" class="remote-seq-select" onchange="remoteChanged(3)"></select>
            <input id="remote_url_3" class="remote-url-input" placeholder="/api/..." onchange="remoteChanged(3)" style="display:none;">
          </td>
        </tr>
        <tr>
          <td>Otoƒçka vlevo (‚Ü∫)</td>
          <td>
            <select id="remote_type_4" onchange="remoteChanged(4)">
              <option value="none">vypnuto</option>
              <option value="seq">sekvence</option>
              <option value="url">URL p≈ô√≠kaz</option>
            </select>
          </td>
          <td>
            <select id="remote_seq_4" class="remote-seq-select" onchange="remoteChanged(4)"></select>
            <input id="remote_url_4" class="remote-url-input" placeholder="/api/..." onchange="remoteChanged(4)" style="display:none;">
          </td>
        </tr>
        <tr>
          <td>Otoƒçka vpravo (‚Üª)</td>
          <td>
            <select id="remote_type_5" onchange="remoteChanged(5)">
              <option value="none">vypnuto</option>
              <option value="seq">sekvence</option>
              <option value="url">URL p≈ô√≠kaz</option>
            </select>
          </td>
          <td>
            <select id="remote_seq_5" class="remote-seq-select" onchange="remoteChanged(5)"></select>
            <input id="remote_url_5" class="remote-url-input" placeholder="/api/..." onchange="remoteChanged(5)" style="display:none;">
          </td>
        </tr>
        </tbody>
      </table>

      <div class="row" style="margin-top:0.6rem;">
        <button class="btn-save" onclick="saveRemoteConfig()">üíæ Ulo≈æit nastaven√≠ ovladaƒçe</button>
      </div>
    </div>

    <!-- OTTO DIY ROBOT ‚Äì vizu√°ln√≠ diagram s p≈ôi≈ôazen√≠m sekvenc√≠ -->
    <div class="card otto-card">
      <h3>OTTO DIY robot ‚Äì diagram pohyb≈Ø</h3>
      <p class="small">
        Ka≈æd√©mu smƒõru pohybu (nahoru/dol≈Ø nebo doleva/doprava) m≈Ø≈æe≈° p≈ôi≈ôadit sekvenci
        (n√°zev bez <code>seq_</code>). Vyb√≠r√° se z ulo≈æen√Ωch sekvenc√≠ v seznamu n√≠≈æe.
        Diagram se ukl√°d√° do prohl√≠≈æeƒçe a pou≈æ√≠v√° ho i z√°lo≈æka <strong>D√≠tƒõ</strong>.
      </p>

      <div class="otto-diagram">
        <!-- ≈ô√°dek hlavy -->
        <div></div>
        <div class="otto-part">
          <div class="otto-shape otto-head"></div>
          <div>hlava</div>
        </div>
        <div></div>

        <!-- ≈ô√°dek ruce + tƒõlo -->
        <div class="otto-part">
          <div class="otto-label-strong">L ruka</div>
          <div class="otto-seq">
            <div class="otto-seq-row">
              <button class="btn-mini" title="L ruka nahoru" onclick="ottoSeqFire('otto_seq_arm_left_up')">‚ñ≤</button>
              <select id="otto_seq_arm_left_up"></select>
            </div>
            <div class="otto-seq-row">
              <button class="btn-mini" title="L ruka dol≈Ø" onclick="ottoSeqFire('otto_seq_arm_left_down')">‚ñº</button>
              <select id="otto_seq_arm_left_down"></select>
            </div>
          </div>
        </div>
        <div class="otto-part">
          <div class="otto-shape otto-body"></div>
          <div>tƒõlo</div>
        </div>
        <div class="otto-part">
          <div class="otto-label-strong">P ruka</div>
          <div class="otto-seq">
            <div class="otto-seq-row">
              <button class="btn-mini" title="P ruka nahoru" onclick="ottoSeqFire('otto_seq_arm_right_up')">‚ñ≤</button>
              <select id="otto_seq_arm_right_up"></select>
            </div>
            <div class="otto-seq-row">
              <button class="btn-mini" title="P ruka dol≈Ø" onclick="ottoSeqFire('otto_seq_arm_right_down')">‚ñº</button>
              <select id="otto_seq_arm_right_down"></select>
            </div>
          </div>
        </div>

        <!-- ≈ô√°dek nohy -->
        <div class="otto-part">
          <div class="otto-shape otto-leg"></div>
          <div class="otto-label-strong">L noha</div>
          <div class="otto-seq">
            <div class="otto-seq-row">
              <button class="btn-mini" title="L stehno doleva" onclick="ottoSeqFire('otto_seq_thigh_left_left')">‚óÄ</button>
              <select id="otto_seq_thigh_left_left"></select>
            </div>
            <div class="otto-seq-row">
              <button class="btn-mini" title="L stehno doprava" onclick="ottoSeqFire('otto_seq_thigh_left_right')">‚ñ∂</button>
              <select id="otto_seq_thigh_left_right"></select>
            </div>
          </div>
        </div>
        <div class="otto-part">
          <div></div>
        </div>
        <div class="otto-part">
          <div class="otto-shape otto-leg"></div>
          <div class="otto-label-strong">P noha</div>
          <div class="otto-seq">
            <div class="otto-seq-row">
              <button class="btn-mini" title="P stehno doleva" onclick="ottoSeqFire('otto_seq_thigh_right_left')">‚óÄ</button>
              <select id="otto_seq_thigh_right_left"></select>
            </div>
            <div class="otto-seq-row">
              <button class="btn-mini" title="P stehno doprava" onclick="ottoSeqFire('otto_seq_thigh_right_right')">‚ñ∂</button>
              <select id="otto_seq_thigh_right_right"></select>
            </div>
          </div>
        </div>

        <!-- ≈ô√°dek chodidla -->
        <div class="otto-part">
          <div class="otto-shape otto-foot"></div>
          <div class="otto-label-strong">L chodidlo</div>
          <div class="otto-seq">
            <div class="otto-seq-row">
              <button class="btn-mini" title="L chodidlo nahoru" onclick="ottoSeqFire('otto_seq_foot_left_up')">‚ñ≤</button>
              <select id="otto_seq_foot_left_up"></select>
            </div>
            <div class="otto-seq-row">
              <button class="btn-mini" title="L chodidlo dol≈Ø" onclick="ottoSeqFire('otto_seq_foot_left_down')">‚ñº</button>
              <select id="otto_seq_foot_left_down"></select>
            </div>
          </div>
        </div>
        <div></div>
        <div class="otto-part">
          <div class="otto-shape otto-foot"></div>
          <div class="otto-label-strong">P chodidlo</div>
          <div class="otto-seq">
            <div class="otto-seq-row">
              <button class="btn-mini" title="P chodidlo nahoru" onclick="ottoSeqFire('otto_seq_foot_right_up')">‚ñ≤</button>
              <select id="otto_seq_foot_right_up"></select>
            </div>
            <div class="otto-seq-row">
              <button class="btn-mini" title="P chodidlo dol≈Ø" onclick="ottoSeqFire('otto_seq_foot_right_down')">‚ñº</button>
              <select id="otto_seq_foot_right_down"></select>
            </div>
          </div>
        </div>
      </div>

      <p class="small" style="margin-top:0.6rem;">
        Tip: sekvence m≈Ø≈æe ovl√°dat i v√≠ce serv z√°rove≈à (nap≈ô. ch≈Øze vp≈ôed pracuje s obƒõma nohama).
        Diagram je jen vizu√°ln√≠ pom≈Øcka, aby bylo d√≠tƒõti jasn√©, co se m√° h√Ωbat.
      </p>
    </div>
  </div>

  <!-- TAB: Serva -->
  <div class="tab-panel" id="tab-control">
    <div class="layout">
      <div class="card">
        <h2>Serva</h2>
        <p class="small">
          Nastav popisy, p≈ôi≈ôaƒè GPIO a testuj smƒõrem vlevo/vpravo.  
          Impulz trv√° p≈ôednastaven√Ω ƒças (PULSE&nbsp;ms).
        </p>
        <div id="servoCards" class="servo-grid"></div>
      </div>

      <div class="card">
        <h2>Nastaven√≠</h2>
        <div class="row">
          <span class="small">Krok v√Ωkonu (%)</span>
          <input type="number" id="stepInput" min="1" max="100" value="10">
        </div>
        <div class="row">
          <span class="small">D√©lka impulzu PULSE (ms)</span>
          <input type="number" id="pulseInput" min="10" max="5000" value="50">
        </div>
        <div class="row">
          <button class="btn-save" onclick="saveMainConfig()">üíæ Ulo≈æit konfiguraci</button>
          <button class="btn secondary" onclick="loadConfigFromDevice()">‚Üª Znovu naƒç√≠st</button>
        </div>

        <hr style="border-color:rgba(255,255,255,0.1);margin:10px 0">

        <h3>Hromadn√© akce</h3>
        <div class="row">
          <button class="btn" onclick="centerAll()">‚è∫ Center ALL</button>
          <button class="btn danger" onclick="stopAll()">‚ñ† Stop ALL</button>
        </div>

        <h3>Stav</h3>
        <p class="small" id="statusText">Naƒç√≠t√°m...</p>
      </div>
    </div>
  </div>

  <!-- TAB: Sekvence -->
  <div class="tab-panel" id="tab-seq">
    <div class="layout">
      <div class="card">
        <h2>Ulo≈æen√© sekvence</h2>
        <p class="small" id="seqLegend">Serva: naƒç√≠t√°m...</p>
        <div class="row">
          <select id="seqSelect" style="min-width:140px;" onchange="loadSelectedSeq()"></select>
          <button class="btn" onclick="newSeq()">Ôºã Nov√° sekvence</button>
          <button class="btn danger" onclick="deleteSeq()">üóë Smazat</button>
        </div>
        <textarea id="seqEditor" placeholder="# servo,power,duration_ms&#10;0,50,1000"></textarea>
        <div class="row">
          <button class="btn-save" onclick="saveSeq()">üíæ Ulo≈æit sekvenci</button>
          <button class="btn" onclick="runSeq()">‚ñ∂ Spustit</button>
        </div>
      </div>

      <div class="card">
        <h2>N√°povƒõda k sekvenc√≠m</h2>
        <p class="small">
          Ka≈æd√Ω ≈ô√°dek: <code>servo,power,duration_ms</code><br>
          <code>servo</code> = 0‚Äì5, <code>power</code> = -100‚Ä¶100, <code>duration_ms</code> = 0 a≈æ 30000.<br>
          <code>#</code> na zaƒç√°tku ≈ô√°dku znamen√° koment√°≈ô.
        </p>
        <pre class="small" style="background:#070915;border-radius:10px;padding:6px 8px;overflow:auto;">
# krok vp≈ôed (jednoduch√Ω p≈ô√≠klad)
0,60,600
3,60,600

# vlnƒõn√≠ rukama
4,70,400
4,-70,400
5,70,400
5,-70,400
        </pre>
      </div>
    </div>
  </div>

  <!-- TAB: OTA & soubory -->
  <div class="tab-panel" id="tab-ota">
    <div class="layout">
      <div class="card">
        <h2>OTA aktualizace</h2>
        <p class="small">
          1) Pro nahr√°n√≠ firmware z Arduino IDE pou≈æij s√≠≈•ov√Ω port (ArduinoOTA).<br>
          2) Nebo nahraj hotov√Ω <code>.bin</code> soubor p≈ôes formul√°≈ô n√≠≈æe.
        </p>
        <form id="otaForm" method="POST" action="/update" enctype="multipart/form-data">
          <input type="file" name="update" accept=".bin" required>
          <div class="row">
            <button class="btn-save" type="submit">‚¨Ü Nahr√°t .bin firmware</button>
          </div>
        </form>
        <p class="small" id="otaStatus"></p>
      </div>

      <div class="card">
        <h2>Spr√°vce soubor≈Ø (LittleFS)</h2>
        <div class="row">
          <button class="btn secondary" onclick="loadFsList()">‚Üª Obnovit seznam</button>
          <span class="small">/config.txt ¬∑ /index.html ¬∑ /seq_*.txt ‚Ä¶</span>
        </div>
        <div id="fsList" class="file-list"></div>

        <h3>√öprava souboru</h3>
        <div class="row">
          <input type="text" id="fsPath" placeholder="/config.txt" style="flex:1;">
          <button class="btn" onclick="fsLoadFile()">Naƒç√≠st</button>
          <button class="btn-save" onclick="fsSaveFile()">Ulo≈æit</button>
        </div>
        <textarea id="fsEditor" placeholder="Obsah souboru..."></textarea>
        <p class="small" id="fsStatus"></p>
      </div>
    </div>
  </div>

</main>

<script>
  const SERVO_COUNT = 6;
  const REMOTE_BTN_COUNT = 6;
  const OTTO_INPUT_IDS = [
    'otto_seq_arm_left_up',
    'otto_seq_arm_left_down',
    'otto_seq_arm_right_up',
    'otto_seq_arm_right_down',
    'otto_seq_thigh_left_left',
    'otto_seq_thigh_left_right',
    'otto_seq_thigh_right_left',
    'otto_seq_thigh_right_right',
    'otto_seq_foot_left_up',
    'otto_seq_foot_left_down',
    'otto_seq_foot_right_up',
    'otto_seq_foot_right_down'
  ];

  const gpioOptions = [
    2, 4, 5,
    12, 13, 14, 15,
    16, 17, 18, 19,
    21, 22, 23,
    25, 26, 27,
    32, 33
  ];

  let currentConfig = {
    step: 10,
    pulse: 50,
    pins: [13,14,25,26,27,32],
    descs: ["","","","","",""],
    remote: []
  };

  let remoteCfg = Array.from({length: REMOTE_BTN_COUNT},
    () => ({type:'none', value:''}));

  // seznam n√°zv≈Ø sekvenc√≠ (bez "seq_")
  let seqNames = [];

  // UI-only p≈ôep√≠naƒç smƒõru pro jednotliv√° serva (swap)
  let servoSwap = Array.from({length: SERVO_COUNT}, () => false);

  function loadServoSwapFromStorage(){
    try{
      const raw = localStorage.getItem('otto_servo_swap');
      if (!raw) return;
      const arr = JSON.parse(raw);
      if (Array.isArray(arr)){
        servoSwap = servoSwap.map((_,i)=>!!arr[i]);
      }
    }catch(e){
      console.error(e);
    }
  }

  function saveServoSwapToStorage(){
    try{
      localStorage.setItem('otto_servo_swap', JSON.stringify(servoSwap));
    }catch(e){
      console.error(e);
    }
  }

  function updateServoSwapButton(idx){
    const btn = document.getElementById(`servo_swap_${idx}`);
    if (!btn) return;
    btn.textContent = `Swap smƒõr: ${servoSwap[idx] ? 'ON' : 'OFF'}`;
  }

  function toggleServoSwap(idx){
    servoSwap[idx] = !servoSwap[idx];
    updateServoSwapButton(idx);
    saveServoSwapToStorage();
  }

  // ----- OTTO diagram ‚Äì ulo≈æen√≠ nastaven√≠ v prohl√≠≈æeƒçi (pro dƒõtsk√Ω re≈æim) -----
  function loadOttoDiagramConfigFromStorage(){
    try{
      const raw = localStorage.getItem('otto_diagram_cfg');
      if (!raw) return;
      const obj = JSON.parse(raw);
      if (!obj || typeof obj !== 'object') return;
      OTTO_INPUT_IDS.forEach(id=>{
        const el = document.getElementById(id);
        if (el && typeof obj[id] === 'string'){
          el.value = obj[id];
        }
      });
    }catch(e){
      console.error(e);
    }
  }

  function saveOttoDiagramConfigToStorage(){
    try{
      const obj = {};
      OTTO_INPUT_IDS.forEach(id=>{
        const el = document.getElementById(id);
        if (el && el.value){
          obj[id] = el.value;
        }
      });
      localStorage.setItem('otto_diagram_cfg', JSON.stringify(obj));
    }catch(e){
      console.error(e);
    }
  }

  function initOttoDiagramBindings(){
    OTTO_INPUT_IDS.forEach(id=>{
      const el = document.getElementById(id);
      if (el){
        el.addEventListener('change', saveOttoDiagramConfigToStorage);
      }
    });
  }

  // ----- Tabs -----
  function initTabs(){
    document.querySelectorAll('.tab-btn').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        const tabId = btn.dataset.tab;
        document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active'));
        document.querySelectorAll('.tab-panel').forEach(p=>p.classList.remove('active'));
        btn.classList.add('active');
        document.getElementById(tabId).classList.add('active');

        if (tabId === 'tab-seq') {
          loadSeqList();
        } else if (tabId === 'tab-remote') {
          updateSeqServoLegend();
          updateRemoteSettingsUI();
        } else if (tabId === 'tab-kid') {
          updateSeqServoLegend();
        }
      });
    });
  }

  // ----- Servo UI -----
  function buildServoUI(){
    const container = document.getElementById('servoCards');
    container.innerHTML = '';
    for(let i=0;i<SERVO_COUNT;i++){
      const card = document.createElement('div');
      card.className = 'servo-card';
      card.innerHTML = `
        <div class="servo-header">
          <div>Servo ${i}</div>
          <div class="servo-state" id="servo_state_${i}">v√Ωkon 0% ¬∑ STOP</div>
        </div>
        <input id="servo_desc_${i}" maxlength="32" class="servo-desc" placeholder="Popis serva" />
        <div class="servo-row">
          <select id="servo_pin_${i}">
            ${gpioOptions.map(p=>`<option value="${p}">GPIO ${p}</option>`).join('')}
          </select>
          <button class="btn-mini" onclick="moveServo(${i},-1)">‚óÄ</button>
          <button class="btn-mini" onclick="moveServo(${i},+1)">‚ñ∂</button>
        </div>
        <div class="servo-row">
          <button class="btn-mini" onclick="centerOne(${i})">Center</button>
          <button class="btn-mini danger" onclick="stopOne(${i})">Stop</button>
        </div>
        <div class="servo-row">
          <button class="btn-mini secondary" id="servo_swap_${i}" onclick="toggleServoSwap(${i})">Swap smƒõr: OFF</button>
        </div>
      `;
      container.appendChild(card);
    }
    // po vytvo≈ôen√≠ karet obnov√≠me stav tlaƒç√≠tek swap podle ulo≈æen√© konfigurace
    for (let i=0;i<SERVO_COUNT;i++){
      updateServoSwapButton(i);
    }
  }

  function updateServoStates(status){
    if (!status || !status.servos) return;
    status.servos.forEach(s=>{
      const el = document.getElementById(`servo_state_${s.index}`);
      if (!el) return;
      const st = s.power === 0 ? (s.attached ? 'CENTER' : 'STOP') : 'AKTIVN√ç';
      el.textContent = `v√Ωkon ${s.power}% ¬∑ ${st}`;
    });
  }

  function moveServo(idx, dir){
    const step = parseInt(document.getElementById('stepInput').value || '10',10);
    const invert = servoSwap[idx] ? -1 : 1;
    const realDir = dir * invert;
    fetch(`/api/move?servo=${idx}&dir=${realDir}&step=${step}`)
      .then(r=>r.text())
      .then(t=>console.log(t))
      .catch(console.error);
  }
  function centerOne(idx){
    fetch(`/api/center_one?servo=${idx}`).then(()=>refreshStatus());
  }
  function centerAll(){
    fetch('/api/center_all').then(()=>refreshStatus());
  }
  function stopOne(idx){
    fetch(`/api/stop_one?servo=${idx}`).then(()=>refreshStatus());
  }
  function stopAll(){
    fetch('/api/stop_all').then(()=>refreshStatus());
  }

  // ----- Config -----
  function updateSeqServoLegend(){
    const legend = currentConfig.descs.map((d,i)=>`${i}: ${d || '(bez popisu)'}`).join(' ¬∑ ');
    const el = document.getElementById('seqLegend');
    if (el) el.textContent = 'Mapov√°n√≠ serv: ' + legend;
  }

  function applyConfigToUI(cfg){
    if (!cfg) return;
    currentConfig = cfg;

    document.getElementById('stepInput').value  = cfg.step;
    document.getElementById('pulseInput').value = cfg.pulse;

    if (Array.isArray(cfg.pins)){
      cfg.pins.forEach((p,i)=>{
        const sel = document.getElementById(`servo_pin_${i}`);
        if (sel){
          sel.value = p;
        }
      });
    }
    if (Array.isArray(cfg.descs)){
      cfg.descs.forEach((d,i)=>{
        const inp = document.getElementById(`servo_desc_${i}`);
        if (inp) inp.value = d || '';
      });
    }
    if (Array.isArray(cfg.remote) && cfg.remote.length === REMOTE_BTN_COUNT){
      for (let i=0;i<REMOTE_BTN_COUNT;i++){
        const r = cfg.remote[i] || {};
        remoteCfg[i] = {
          type: (r.type || 'none'),
          value: (r.value || '')
        };
      }
      updateRemoteSettingsUI();
    }
    updateSeqServoLegend();
  }

  function loadConfigFromDevice(){
    fetch('/api/config')
      .then(r=>r.json())
      .then(applyConfigToUI)
      .catch(e=>{
        console.error(e);
        document.getElementById('statusText').textContent = 'Chyba p≈ôi naƒç√≠t√°n√≠ konfigurace.';
      });
  }

  function saveMainConfig(){
    let step  = parseInt(document.getElementById('stepInput').value || '10',10);
    let pulse = parseInt(document.getElementById('pulseInput').value || '50',10);
    step  = Math.min(100,Math.max(1,step));
    pulse = Math.min(5000,Math.max(10,pulse));

    // ulo≈æit popisy
    for(let i=0;i<SERVO_COUNT;i++){
      const desc = document.getElementById(`servo_desc_${i}`).value || '';
      fetch(`/api/set_desc?servo=${i}&desc=${encodeURIComponent(desc)}`);
    }
    // ulo≈æit p≈ôi≈ôazen√≠ GPIO
    for(let i=0;i<SERVO_COUNT;i++){
      const pin = document.getElementById(`servo_pin_${i}`).value;
      fetch(`/api/set_pin?servo=${i}&gpio=${pin}`);
    }

    fetch(`/api/save_config?step=${step}&pulse=${pulse}`)
      .then(r=>r.text())
      .then(t=>{
        document.getElementById('statusText').textContent = t;
        loadConfigFromDevice();
      })
      .catch(e=>{
        console.error(e);
        document.getElementById('statusText').textContent = 'Chyba p≈ôi ukl√°d√°n√≠ konfigurace.';
      });
  }

  // ----- Status -----
  function refreshStatus(){
    fetch('/api/status')
      .then(r=>r.json())
      .then(s=>{
        updateServoStates(s);
        document.getElementById('statusText').textContent = 'Stav serv aktualizov√°n.';
      })
      .catch(e=>{
        console.error(e);
        document.getElementById('statusText').textContent = 'Chyba p≈ôi ƒçten√≠ stavu serv.';
      });
  }

  // ----- Sekvence -----
  function refreshAllSeqSelectors(){
    const names = seqNames || [];

    // Remote ovladaƒç ‚Äì dropdowny
    for (let i=0;i<REMOTE_BTN_COUNT;i++){
      const sel = document.getElementById(`remote_seq_${i}`);
      if (!sel) continue;
      const current = sel.value;
      sel.innerHTML = '';
      const emptyOpt = document.createElement('option');
      emptyOpt.value = '';
      emptyOpt.textContent = '(≈æ√°dn√°)';
      sel.appendChild(emptyOpt);
      names.forEach(n=>{
        const opt = document.createElement('option');
        opt.value = n;
        opt.textContent = n;
        sel.appendChild(opt);
      });
      if (current && names.includes(current)){
        sel.value = current;
      }
    }

    // OTTO diagram ‚Äì dropdowny
    OTTO_INPUT_IDS.forEach(id=>{
      const sel = document.getElementById(id);
      if (!sel) return;
      const current = sel.value;
      sel.innerHTML = '';
      const emptyOpt = document.createElement('option');
      emptyOpt.value = '';
      emptyOpt.textContent = '(≈æ√°dn√°)';
      sel.appendChild(emptyOpt);
      names.forEach(n=>{
        const opt = document.createElement('option');
        opt.value = n;
        opt.textContent = n;
        sel.appendChild(opt);
      });
      if (current && names.includes(current)){
        sel.value = current;
      }
    });
  }

  // Naƒçten√≠ seznamu sekvenc√≠ z LittleFS p≈ôes /api/fs_list (filtrov√°no na /seq_*.txt)
  function loadSeqList(){
    fetch('/api/fs_list')
      .then(r=>r.json())
      .then(data=>{
        const files = (data.files || []);
        const names = [];

        files.forEach(f=>{
          let n = f.name || '';
          if (!n) return;
          // od≈ô√≠zni p≈ô√≠padnou cestu
          const slash = n.lastIndexOf('/');
          if (slash >= 0) n = n.substring(slash + 1);
          // ƒçek√°me soubory typu seq_<name>.txt
          if (!n.startsWith('seq_') || !n.endsWith('.txt')) return;
          const base = n.substring(4, n.length - 4);
          if (base && !names.includes(base)) names.push(base);
        });

        seqNames = names;

        const sel = document.getElementById('seqSelect');
        const editor = document.getElementById('seqEditor');
        const previous = sel.value;

        sel.innerHTML = '';
        seqNames.forEach(name=>{
          const opt = document.createElement('option');
          opt.value = name;
          opt.textContent = name;
          sel.appendChild(opt);
        });

        if (seqNames.length){
          if (previous && seqNames.includes(previous)){
            sel.value = previous;
          }else{
            sel.value = seqNames[0];
          }
          loadSelectedSeq();
        }else{
          if (editor) editor.value = '';
        }

        // update v≈°ech dropdown≈Ø (remote + OTTO)
        refreshAllSeqSelectors();
        // po p≈ôepoƒçtu dropdown≈Ø znovu nat√°hneme stav remoteCfg
        updateRemoteSettingsUI();
        // a konfiguraci OTTO z localStorage (p≈ôi prvn√≠m naƒçten√≠)
        loadOttoDiagramConfigFromStorage();
      })
      .catch(console.error);
  }

  function loadSelectedSeq(){
    const sel = document.getElementById('seqSelect');
    const name = sel.value;
    if (!name) return;
    const path = `/seq_${name}.txt`;
    fetch(`/api/fs_get?path=${encodeURIComponent(path)}`)
      .then(r=>r.text())
      .then(t=>{ document.getElementById('seqEditor').value = t; })
      .catch(console.error);
  }

  function newSeq(){
    const name = prompt('N√°zev nov√© sekvence (bez "seq_")?');
    if (!name) return;
    const sel = document.getElementById('seqSelect');
    const opt = document.createElement('option');
    opt.value = name;
    opt.textContent = name;
    sel.appendChild(opt);
    sel.value = name;
    document.getElementById('seqEditor').value = '# nova sekvence\n';
  }

  function saveSeq(){
    const sel = document.getElementById('seqSelect');
    const name = sel.value;
    if (!name){ alert('Vyber nebo vytvo≈ô sekvenci.'); return; }
    const body = document.getElementById('seqEditor').value || '';
    const path = `/seq_${name}.txt`;
    fetch(`/api/fs_put?path=${encodeURIComponent(path)}`,{
      method:'POST',
      headers:{'Content-Type':'text/plain'},
      body
    }).then(r=>r.text())
      .then(t=>{
        alert(t);
        loadSeqList(); // aktualizuj seznam a dropdowny po ulo≈æen√≠
      })
      .catch(console.error);
  }

  function deleteSeq(){
    const sel = document.getElementById('seqSelect');
    const name = sel.value;
    if (!name) return;
    if (!confirm(`Smazat sekvenci "${name}"?`)) return;
    const path = `/seq_${name}.txt`;
    fetch(`/api/fs_delete?path=${encodeURIComponent(path)}`)
      .then(r=>r.text())
      .then(t=>{
        alert(t);
        loadSeqList(); // po smaz√°n√≠ aktualizuj seznam a dropdowny
      })
      .catch(console.error);
  }

  // Lok√°ln√≠ interpret sekvence ‚Äì prov√°d√≠ ≈ô√°dky p≈ôes /api/move a /api/stop_one
  function scheduleLocalSequence(text){
    const lines = (text || '').split(/\r?\n/);
    const steps = [];

    lines.forEach(line=>{
      const raw = line.trim();
      if (!raw || raw.startsWith('#')) return;
      const parts = raw.split(',');
      if (parts.length < 3) return;

      const servo = parseInt(parts[0],10);
      const power = parseInt(parts[1],10);
      const dur   = parseInt(parts[2],10);
      if (isNaN(servo) || isNaN(power) || isNaN(dur)) return;
      if (servo < 0 || servo >= SERVO_COUNT) return;

      const duration = Math.max(0, dur);
      const absPower = Math.min(100, Math.max(1, Math.abs(power)));
      const dir = power >= 0 ? 1 : -1;

      steps.push({servo, dir, absPower, duration});
    });

    if (!steps.length){
      alert('V sekvenci nejsou ≈æ√°dn√© platn√© kroky.');
      return;
    }

    let t = 0;
    steps.forEach(step=>{
      setTimeout(()=>{
        fetch(`/api/move?servo=${step.servo}&dir=${step.dir}&step=${step.absPower}`)
          .catch(console.error);
        if (step.duration > 0){
          setTimeout(()=>{
            fetch(`/api/stop_one?servo=${step.servo}`).catch(console.error);
          }, step.duration);
        }
      }, t);
      t += step.duration;
    });

    alert(`Sekvence spu≈°tƒõna, krok≈Ø: ${steps.length}`);
  }

  // Naƒçte sekvenci podle n√°zvu z LittleFS a spust√≠ ji p≈ôes scheduleLocalSequence
  function runNamedSequence(name, statusId, silentOnError){
    const statusEl = statusId ? document.getElementById(statusId) : null;
    const seqName = (name || '').trim();
    if (!seqName){
      if (statusEl) statusEl.textContent = 'Chyb√≠ n√°zev sekvence.';
      if (!silentOnError) alert('Chyb√≠ n√°zev sekvence.');
      return;
    }

    const path = `/seq_${seqName}.txt`;
    if (statusEl) statusEl.textContent = 'Naƒç√≠t√°m sekvenci...';

    fetch(`/api/fs_get?path=${encodeURIComponent(path)}`)
      .then(r=>{
        if (!r.ok) throw new Error('HTTP '+r.status);
        return r.text();
      })
      .then(text=>{
        if (statusEl) statusEl.textContent = 'Spou≈°t√≠m sekvenci...';
        scheduleLocalSequence(text);
      })
      .catch(e=>{
        console.error(e);
        if (statusEl) statusEl.textContent = 'Sekvence nenalezena nebo chyba p≈ôi naƒç√≠t√°n√≠.';
        if (!silentOnError) alert('Sekvence nebyla nalezena nebo do≈°lo k chybƒõ p≈ôi naƒç√≠t√°n√≠.');
      });
  }

  function runSeq(){
    const text = document.getElementById('seqEditor').value || '';
    if (!text.trim()){
      alert('Sekvence je pr√°zdn√°.');
      return;
    }
    scheduleLocalSequence(text);
  }

  // ===== Remote ovladaƒç (frontend) =====
  function updateRemoteSettingsUI(){
    for (let i=0;i<REMOTE_BTN_COUNT;i++){
      const cfg = remoteCfg[i] || {type:'none', value:''};
      const selType = document.getElementById(`remote_type_${i}`);
      const selSeq  = document.getElementById(`remote_seq_${i}`);
      const inpUrl  = document.getElementById(`remote_url_${i}`);

      if (selType) selType.value = cfg.type || 'none';

      if (cfg.type === 'seq'){
        if (selSeq){
          selSeq.style.display = '';
          selSeq.value = cfg.value || '';
        }
        if (inpUrl){
          inpUrl.style.display = 'none';
          inpUrl.value = '';
        }
      } else if (cfg.type === 'url'){
        if (selSeq){
          selSeq.style.display = 'none';
        }
        if (inpUrl){
          inpUrl.style.display = '';
          inpUrl.value = cfg.value || '';
        }
      } else {
        if (selSeq){
          selSeq.style.display = '';
          selSeq.value = '';
        }
        if (inpUrl){
          inpUrl.style.display = 'none';
          inpUrl.value = '';
        }
      }
    }
  }

  function remoteChanged(i){
    const selType = document.getElementById(`remote_type_${i}`);
    const selSeq  = document.getElementById(`remote_seq_${i}`);
    const inpUrl  = document.getElementById(`remote_url_${i}`);
    if (!selType || !selSeq || !inpUrl) return;

    const type = selType.value || 'none';

    if (type === 'seq'){
      selSeq.style.display = '';
      inpUrl.style.display = 'none';
      remoteCfg[i] = {
        type: 'seq',
        value: selSeq.value || ''
      };
    } else if (type === 'url'){
      selSeq.style.display = 'none';
      inpUrl.style.display = '';
      remoteCfg[i] = {
        type: 'url',
        value: (inpUrl.value || '').trim()
      };
    } else {
      selSeq.style.display = '';
      inpUrl.style.display = 'none';
      remoteCfg[i] = {
        type: 'none',
        value: ''
      };
    }
  }

  // spoleƒçn√© j√°dro pro tlaƒç√≠tka (dospƒõl√Ω / d√≠tƒõ)
  function remoteFireGeneric(i, options){
    const cfg = remoteCfg[i] || {type:'none', value:''};
    const statusId = options && options.statusElementId ? options.statusElementId : 'remoteStatus';
    const silentIfUnconfigured = options && options.silentIfUnconfigured;
    const statusEl = document.getElementById(statusId);

    if (cfg.type === 'none' || !cfg.type){
      if (!silentIfUnconfigured) alert('Toto tlaƒç√≠tko zat√≠m nem√° p≈ôi≈ôazenou akci.');
      if (statusEl) statusEl.textContent = 'Tlaƒç√≠tko nen√≠ nakonfigurov√°no.';
      return;
    }
    if (!cfg.value && cfg.type !== 'none'){
      if (!silentIfUnconfigured) alert('Pro toto tlaƒç√≠tko chyb√≠ n√°zev sekvence nebo URL.');
      if (statusEl) statusEl.textContent = 'Chyb√≠ n√°zev sekvence nebo URL.';
      return;
    }

    // sekvence spou≈°t√≠me lok√°lnƒõ ‚Äì naƒçteme z LittleFS a interpretujeme
    if (cfg.type === 'seq'){
      const name = cfg.value.trim();
      runNamedSequence(name, statusId, silentIfUnconfigured);
      return;
    }

    let url = '';
    if (cfg.type === 'url'){
      let v = cfg.value.trim();
      if (!v.startsWith('/')) v = '/' + v;
      url = v;
    }

    if (statusEl) statusEl.textContent = 'Odes√≠l√°m p≈ô√≠kaz...';
    fetch(url)
      .then(r=>r.text())
      .then(t=>{ if (statusEl) statusEl.textContent = t; })
      .catch(e=>{
        console.error(e);
        if (statusEl) statusEl.textContent = 'Chyba p≈ôi odes√≠l√°n√≠ p≈ô√≠kazu.';
      });
  }

  function remoteFire(i){
    // re≈æim dospƒõl√©ho ‚Äì klasick√© chov√°n√≠
    remoteFireGeneric(i, {statusElementId:'remoteStatus', silentIfUnconfigured:false});
  }

  function kidRemoteFire(i){
    // re≈æim d√≠tƒõte ‚Äì bez alert≈Ø, tich√Ω fallback
    remoteFireGeneric(i, {statusElementId:'kidStatus', silentIfUnconfigured:true});
  }

  function saveRemoteConfig(){
    const statusEl = document.getElementById('remoteStatus');
    const promises = [];
    for (let i=0;i<REMOTE_BTN_COUNT;i++){
      const cfg = remoteCfg[i] || {type:'none', value:''};
      const type = cfg.type || 'none';
      const val  = cfg.value || '';
      const url = `/api/remote_save?idx=${i}&type=${encodeURIComponent(type)}&value=${encodeURIComponent(val)}`;
      promises.push(fetch(url).then(r=>r.text()));
    }
    if (statusEl) statusEl.textContent = 'Ukl√°d√°m nastaven√≠ ovladaƒçe...';
    Promise.all(promises)
      .then(()=>{ if (statusEl) statusEl.textContent = 'Nastaven√≠ ovladaƒçe ulo≈æeno.'; })
      .catch(e=>{
        console.error(e);
        if (statusEl) statusEl.textContent = 'Chyba p≈ôi ukl√°d√°n√≠ nastaven√≠ ovladaƒçe.';
      });
  }

  // ----- OTTO diagram ‚Äì spu≈°tƒõn√≠ sekvenc√≠ -----
  function ottoSeqFireGeneric(inputId, options){
    const inp = document.getElementById(inputId);
    const statusId = options && options.statusElementId ? options.statusElementId : 'remoteStatus';
    const silentIfEmpty = options && options.silentIfEmpty;
    const statusEl = document.getElementById(statusId);

    if (!inp){
      if (!silentIfEmpty) alert('Vnit≈ôn√≠ chyba: nenalezen prvek pro sekvenci.');
      if (statusEl) statusEl.textContent = 'Chyba: nenalezen prvek pro sekvenci.';
      return;
    }
    const name = (inp.value || '').trim();
    if (!name){
      if (!silentIfEmpty) alert('Vyber sekvenci pro toto tlaƒç√≠tko.');
      if (statusEl) statusEl.textContent = 'Chyb√≠ n√°zev sekvence.';
      return;
    }

    // sekvence spou≈°t√≠me lok√°lnƒõ z LittleFS
    runNamedSequence(name, statusId, silentIfEmpty);
  }

  function ottoSeqFire(inputId){
    // dospƒõl√Ω ‚Äì s alerty, stav do remoteStatus
    ottoSeqFireGeneric(inputId, {statusElementId:'remoteStatus', silentIfEmpty:false});
  }

  function kidOttoSeqFire(inputId){
    // d√≠tƒõ ‚Äì bez alert≈Ø, stav do kidStatus
    ottoSeqFireGeneric(inputId, {statusElementId:'kidStatus', silentIfEmpty:true});
  }

  // ----- File manager -----
  function loadFsList(){
    fetch('/api/fs_list')
      .then(r => r.json())
      .then(data => {
        const list = document.getElementById('fsList');
        list.innerHTML = '';
        (data.files || []).forEach(f => {
          const div = document.createElement('div');
          div.className = 'file-list-item';
          div.innerHTML = `
            <div>
              <div class="file-name">${f.name}</div>
              <div class="meta">${f.size} B</div>
            </div>
            <div class="file-actions">
              <button onclick="fsQuickLoad('${f.name}')">Naƒç√≠st</button>
              <button class="danger" onclick="fsQuickDelete('${f.name}')">Smazat</button>
            </div>
          `;
          list.appendChild(div);
        });

        if (!data.files || !data.files.length) {
          list.innerHTML = '<div class="file-list-item"><span class="small">≈Ω√°dn√© soubory v LittleFS.</span></div>';
        }
      })
      .catch(e => {
        console.error(e);
        const list = document.getElementById('fsList');
        if (list) {
          list.innerHTML = '<div class="file-list-item"><span class="small">Chyba p≈ôi naƒç√≠t√°n√≠ seznamu soubor≈Ø.</span></div>';
        }
      });
  }

  function fsQuickLoad(path){
    const input = document.getElementById('fsPath');
    if (input) input.value = path;
    fsLoadFile();
  }

  function fsQuickDelete(path){
    if (!confirm(`Opravdu smazat soubor "${path}"?`)) return;
    const statusEl = document.getElementById('fsStatus');
    fetch(`/api/fs_delete?path=${encodeURIComponent(path)}`)
      .then(r=>r.text())
      .then(t=>{
        if (statusEl) statusEl.textContent = t;
        loadFsList();
      })
      .catch(e=>{
        console.error(e);
        if (statusEl) statusEl.textContent = 'Chyba p≈ôi maz√°n√≠ souboru.';
      });
  }

  function fsLoadFile(){
    const pathInput = document.getElementById('fsPath');
    const editor    = document.getElementById('fsEditor');
    const statusEl  = document.getElementById('fsStatus');
    if (!pathInput || !editor) return;

    let path = pathInput.value.trim();
    if (!path){
      alert('Zadej cestu k souboru (nap≈ô. /config.txt).');
      return;
    }
    if (!path.startsWith('/')) path = '/' + path;

    if (statusEl) statusEl.textContent = 'Naƒç√≠t√°m soubor...';

    fetch(`/api/fs_get?path=${encodeURIComponent(path)}`)
      .then(r=>{
        if (!r.ok) throw new Error('HTTP '+r.status);
        return r.text();
      })
      .then(t=>{
        editor.value = t;
        pathInput.value = path;
        if (statusEl) statusEl.textContent = 'Soubor naƒçten.';
      })
      .catch(e=>{
        console.error(e);
        if (statusEl) statusEl.textContent = 'Chyba p≈ôi naƒç√≠t√°n√≠ souboru.';
      });
  }

  function fsSaveFile(){
    const pathInput = document.getElementById('fsPath');
    const editor    = document.getElementById('fsEditor');
    const statusEl  = document.getElementById('fsStatus');
    if (!pathInput || !editor) return;

    let path = pathInput.value.trim();
    if (!path){
      alert('Zadej cestu k souboru (nap≈ô. /config.txt).');
      return;
    }
    if (!path.startsWith('/')) path = '/' + path;

    const body = editor.value || '';
    if (statusEl) statusEl.textContent = 'Ukl√°d√°m soubor...';

    fetch(`/api/fs_put?path=${encodeURIComponent(path)}`,{
      method:'POST',
      headers:{'Content-Type':'text/plain'},
      body
    })
    .then(r=>r.text())
    .then(t=>{
      if (statusEl) statusEl.textContent = t;
      loadFsList();
    })
    .catch(e=>{
      console.error(e);
      if (statusEl) statusEl.textContent = 'Chyba p≈ôi ukl√°d√°n√≠ souboru.';
    });
  }

  // ----- OTA form feedback -----
  (function initOtaForm(){
    const form = document.getElementById('otaForm');
    const statusEl = document.getElementById('otaStatus');
    if (!form) return;
    form.addEventListener('submit', ()=>{
      if (statusEl) statusEl.textContent = 'Nahr√°v√°m firmware... Po dokonƒçen√≠ se deska restartuje.';
    });
  })();

  // ----- Init page -----
  function initIpBadge(){
    const badge = document.getElementById('ipBadge');
    if (!badge) return;
    const host = window.location.host || window.location.hostname || '';
    badge.textContent = 'IP: ' + (host || '(nezn√°m√°)');
  }

  window.addEventListener('load', ()=>{
    initIpBadge();
    loadServoSwapFromStorage();
    buildServoUI();
    initTabs();
    loadConfigFromDevice();
    refreshStatus();
    loadFsList();
    loadSeqList(); // z√°rove≈à napln√≠ dropdowny pro sekvence
    // nav√°≈æe zmƒõny OTTO diagramu do localStorage
    initOttoDiagramBindings();
    // pravideln√° aktualizace stavu serv
    setInterval(refreshStatus, 4000);
  });
</script>
</body>
</html>
